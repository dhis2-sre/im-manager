apiVersion: skaffold/v4beta2
kind: Config
metadata:
  name: im-manager
build:
  artifacts:
    - image: dhis2/im-manager
  tagPolicy:
    inputDigest: { }
deploy:
  statusCheckDeadlineSeconds: 240
  tolerateFailuresUntilDeadline: true
  helm:
    releases:
      - name: im-rabbitmq-{{ .ENVIRONMENT }}
        namespace: instance-manager-{{ .ENVIRONMENT }}
        createNamespace: true
        remoteChart: rabbitmq
        repo: https://charts.bitnami.com/bitnami
        version: 10.3.9
        useHelmSecrets: true
        valuesFiles:
          - helm/data/secrets/{{ .ENVIRONMENT }}/rabbitmq.yaml

      - name: im-manager-postgresql-{{ .ENVIRONMENT }}
        namespace: instance-manager-{{ .ENVIRONMENT }}
        createNamespace: true
        remoteChart: postgresql
        repo: https://charts.bitnami.com/bitnami
        version: 11.6.2
        useHelmSecrets: true
        valuesFiles:
          - helm/data/secrets/{{ .ENVIRONMENT }}/postgresql.yaml
          - helm/data/values/{{ .ENVIRONMENT }}/postgresql.yaml

      - name: im-manager-{{ .ENVIRONMENT }}
        namespace: instance-manager-{{ .ENVIRONMENT }}
        createNamespace: true
        chartPath: helm/chart
        setValueTemplates:
          image.repository: dhis2/im-manager
        useHelmSecrets: true
        valuesFiles:
          - helm/data/secrets/{{ .ENVIRONMENT }}/values.yaml
          - helm/data/values/{{ .ENVIRONMENT }}/values.yaml

profiles:
  - name: dev
    deploy:
      helm:
        releases:
          - name: im-group-whoami
            namespace: whoami
            createNamespace: true
            remoteChart: im-group
            repo: https://dhis2-sre.github.io/im-group
            version: 0.2.0
            setValues:
              serviceAccount:
                name: im-manager-dev
                namespace: instance-manager-dev
  - name: prod
    deploy:
      helm:
        releases:
          - name: im-group-dev
            namespace: dev
            createNamespace: true
            remoteChart: im-group
            repo: https://dhis2-sre.github.io/im-group
            version: 0.2.0
            setValues:
              serviceAccount:
                name: im-manager-prod
                namespace: instance-manager-prod

          - name: im-group-play
            namespace: play
            createNamespace: true
            remoteChart: im-group
            repo: https://dhis2-sre.github.io/im-group
            version: 0.2.0
            setValues:
              serviceAccount:
                name: im-manager-prod
                namespace: instance-manager-prod

          - name: im-group-qa
            namespace: qa
            createNamespace: true
            remoteChart: im-group
            repo: https://dhis2-sre.github.io/im-group
            version: 0.2.0
            setValues:
              serviceAccount:
                name: im-manager-prod
                namespace: instance-manager-prod

          - name: im-group-meta-packages
            namespace: meta-packages
            createNamespace: true
            remoteChart: im-group
            repo: https://dhis2-sre.github.io/im-group
            version: 0.2.0
            setValues:
              serviceAccount:
                name: im-manager-prod
                namespace: instance-manager-prod
