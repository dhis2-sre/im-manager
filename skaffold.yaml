apiVersion: skaffold/v2beta25
kind: Config
metadata:
  name: im-manager
build:
  artifacts:
    - image: dhis2/im-manager
  tagPolicy:
    inputDigest: { }
deploy:
  statusCheckDeadlineSeconds: 240
  helm:
    releases:
      - name: im-rabbitmq-{{ .ENVIRONMENT }}
        namespace: instance-manager-{{ .ENVIRONMENT }}
        createNamespace: true
        remoteChart: rabbitmq
        repo: https://charts.bitnami.com/bitnami
        version: 10.3.9
        useHelmSecrets: true
        valuesFiles:
          - helm/data/secrets/{{ .ENVIRONMENT }}/rabbitmq.yaml

      - name: im-manager-postgresql-{{ .ENVIRONMENT }}
        namespace: instance-manager-{{ .ENVIRONMENT }}
        createNamespace: true
        remoteChart: postgresql
        repo: https://charts.bitnami.com/bitnami
        version: 11.6.2
        useHelmSecrets: true
        valuesFiles:
          - helm/data/secrets/{{ .ENVIRONMENT }}/postgresql.yaml
          - helm/data/values/{{ .ENVIRONMENT }}/postgresql.yaml

      - name: im-manager-{{ .ENVIRONMENT }}
        namespace: instance-manager-{{ .ENVIRONMENT }}
        createNamespace: true
        chartPath: helm/chart
        artifactOverrides:
          image: dhis2/im-manager
        imageStrategy:
          helm: { }
        useHelmSecrets: true
        valuesFiles:
          - helm/data/secrets/{{ .ENVIRONMENT }}/values.yaml
          - helm/data/values/{{ .ENVIRONMENT }}/values.yaml
