name: Find Orphaned Helm Releases

on:
  schedule:
    - cron: '0 8 * * *'
  workflow_dispatch:

jobs:
  find-orphaned-releases:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install Helm
        uses: alexellis/arkade-get@master
        with:
          helm: v3.12.3

      - name: Install Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.x'

      - name: Set up Python virtual environment
        run: |
          python -m venv venv
          venv/bin/pip install -r scripts/util/requirements.txt

      - name: Set up Instance Manager credentials
        run: |
          echo "IM_HOST_PROD=https://api.im.dhis2.org" >> $GITHUB_ENV
          echo "USER_EMAIL_PROD=${{ secrets.IM_ADMIN_USER }}" >> $GITHUB_ENV
          echo "PASSWORD_PROD=${{ secrets.IM_ADMIN_PASSWORD }}" >> $GITHUB_ENV

          echo "IM_HOST_DEV=https://api.im-dev.dhis2.org" >> $GITHUB_ENV
          echo "USER_EMAIL_DEV=${{ secrets.IM_ADMIN_USER_DEV }}" >> $GITHUB_ENV
          echo "PASSWORD_DEV=${{ secrets.IM_ADMIN_PASSWORD_DEV }}" >> $GITHUB_ENV

          echo "HTTP=${{ github.workspace }}/venv/bin/https --check-status" >> $GITHUB_ENV

      - name: Create kubeconfig files
        run: |
          echo "${{ secrets.KUBECONFIG }}" > /tmp/eks-kubeconfig
          echo "${{ secrets.HETZNER_KUBECONFIG }}" > /tmp/hetzner-kubeconfig

      - name: Find orphaned Helm Releases
        id: find-orphaned-releases
        run: |
          set -o pipefail
          venv/bin/python scripts/util/find-orphaned-helm-releases.py \
            --kubeconfig /tmp/eks-kubeconfig \
            --kubeconfig /tmp/hetzner-kubeconfig |
            tee /tmp/find-helm-releases-output

          ORPHANED_COUNT=$(grep 'Orphaned Deployments only in Helm' /tmp/find-helm-releases-output | grep --only-matching --regexp='[0-9]\+' || echo "0")
          echo "orphaned_count=$ORPHANED_COUNT" >> $GITHUB_OUTPUT
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      - name: Send Slack notification
        if: steps.find-orphaned-releases.outputs.orphaned_count > '0'
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_CHANNEL: 'team-devops-internal'
          SLACK_MESSAGE: |
            :warning: Orphaned Helm Releases Found

            ${{ steps.find-orphaned-releases.outputs.orphaned_count }} orphaned deployment(s) detected.

            View details and uninstall commands in the GitHub Actions logs (step: "Find orphaned Helm Releases"):
            https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          SLACK_COLOR: 'failure'
